<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flappy Santa - Ú©Ø±ÛŒØ³Ù…Ø³ Ù…Ø¨Ø§Ø±Ú©</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap');

        body {
            margin: 0;
            padding: 0;
            background: #2c3e50;
            font-family: 'Vazirmatn', sans-serif;
            overflow: hidden;
            color: white;
            text-align: center;
        }
        
        #game-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            height: 100vh;
            margin: 0 auto;
            background: linear-gradient(to bottom, #0f2027, #203a43, #2c5364);
            overflow: hidden;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        .overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            background: rgba(192, 57, 43, 0.95);
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #f1c40f;
            display: none;
            z-index: 10;
            box-sizing: border-box;
        }

        #start-screen { display: block; }

        button {
            background: #27ae60;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 1.2rem;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
            font-family: 'Vazirmatn', sans-serif;
            width: 100%;
        }

        button:hover { background: #2ecc71; }
        button:disabled { background: #95a5a6; cursor: not-allowed; }

        input {
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            width: 100%;
            font-family: 'Vazirmatn', sans-serif;
            margin-bottom: 10px;
            box-sizing: border-box;
            color: black;
        }

        #gift-section {
            text-align: center;
            border-top: 2px dashed white;
            margin-top: 20px;
            padding-top: 10px;
        }

        .german-quote {
            font-style: italic;
            font-size: 1.1rem;
            color: #f1c40f;
            margin-bottom: 5px;
            direction: ltr;
        }
        
        .persian-translation {
            font-size: 0.9rem;
            color: #ecf0f1;
        }

        ul { list-style: none; padding: 0; margin: 0; }
        h1, h2, h3 { margin: 10px 0; text-shadow: 2px 2px 4px #000; }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>

    <div id="start-screen" class="overlay">
        <h1>ğŸ… Flappy Santa</h1>
        <p>Ø±ÙˆÛŒ ØµÙØ­Ù‡ Ø¨Ø²Ù†ÛŒØ¯ ØªØ§ Ø¨Ø§Ø¨Ø§Ù†ÙˆØ¦Ù„ Ø¨Ù¾Ø±Ø¯!</p>
        <button onclick="window.startGame()">Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒ</button>
    </div>

    <div id="game-over-screen" class="overlay">
        <h2>Ø¨Ø§Ø²ÛŒ ØªÙ…Ø§Ù… Ø´Ø¯!</h2>
        <p>Ø§Ù…ØªÛŒØ§Ø² Ø´Ù…Ø§: <span id="final-score">0</span></p>
        <p>Ø§Ø³Ù…Øª Ø±Ùˆ Ø¨Ù†ÙˆÛŒØ³ ØªØ§ Ú©Ø§Ø¯ÙˆØª Ø±Ùˆ Ø¨Ú¯ÛŒØ±ÛŒ:</p>
        <input type="text" id="username" placeholder="Ù†Ø§Ù… Ø´Ù…Ø§...">
        <button onclick="window.submitScore()">Ø«Ø¨Øª Ùˆ Ø¯Ø±ÛŒØ§ÙØª Ù‡Ø¯ÛŒÙ‡</button>
    </div>

    <div id="reward-screen" class="overlay" style="max-height: 90vh; overflow-y: auto;">
        <h2>ğŸ Ú©Ø±ÛŒØ³Ù…Ø³ Ù…Ø¨Ø§Ø±Ú©! ğŸ</h2>
        
        <audio id="xmas-music" controls style="width: 100%; margin: 10px 0;">
            <source src="https://upload.wikimedia.org/wikipedia/commons/e/e6/Jingle_Bells_%28Kevin_MacLeod%29_%28Source%29.ogg" type="audio/ogg">
        </audio>

        <div id="gift-section">
            <h3>Ø³Ø®Ù† Ø¨Ø²Ø±Ú¯Ø§Ù†:</h3>
            <p class="german-quote">"Es ist nicht genug zu wissen, man muss auch anwenden." <br><small>- Johann Wolfgang von Goethe</small></p>
            <p class="persian-translation">Â«Ø¯Ø§Ù†Ø³ØªÙ† Ú©Ø§ÙÛŒ Ù†ÛŒØ³ØªØŒ Ø¨Ø§ÛŒØ¯ Ø¨Ù‡ Ø¢Ù† Ø¹Ù…Ù„ Ú©Ø±Ø¯.Â»</p>
        </div>

        <div style="margin-top: 20px; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 10px;">
            <h3>ğŸ† Ø¨Ø±ØªØ±ÛŒÙ†â€ŒÙ‡Ø§</h3>
            <ul id="leaderboard-list">
                <li>Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</li>
            </ul>
        </div>
        
        <button onclick="location.reload()" style="margin-top:15px;">Ø¨Ø§Ø²ÛŒ Ø¯ÙˆØ¨Ø§Ø±Ù‡</button>
    </div>
</div>

<script type="module">
    // --- Ø§ÛŒÙ…Ù¾ÙˆØ±Øªâ€ŒÙ‡Ø§ÛŒ ÙØ§ÛŒØ±Ø¨ÛŒØ³ ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getFirestore, collection, addDoc, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

<script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-analytics.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
  const firebaseConfig = {
    apiKey: "AIzaSyDOpjIX4Q8g4E0urPEPkhQIfxjgl9wTlM8",
    authDomain: "santa-game-6c8e9.firebaseapp.com",
    projectId: "santa-game-6c8e9",
    storageBucket: "santa-game-6c8e9.firebasestorage.app",
    messagingSenderId: "672208830308",
    appId: "1:672208830308:web:39439e23b1a940afadc471",
    measurementId: "G-4EQ17G14X2"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
</script>
    // Ø±Ø§Ù‡ Ø§Ù†Ø¯Ø§Ø²ÛŒ Ø¯ÛŒØªØ§Ø¨ÛŒØ³
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- Ù…Ù†Ø·Ù‚ Ø¨Ø§Ø²ÛŒ ---
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    canvas.width = window.innerWidth > 400 ? 400 : window.innerWidth;
    canvas.height = window.innerHeight;

    let frames = 0;
    let score = 0;
    let gameRunning = false;
    
    // --- Ø·Ø±Ø§Ø­ÛŒ Ø¬Ø¯ÛŒØ¯ Ø¨Ø§Ø¨Ø§Ù†ÙˆØ¦Ù„ ---
    const santa = {
        x: 50, 
        y: 150, 
        w: 30, 
        h: 40, // Ø§Ø±ØªÙØ§Ø¹ Ú©Ù…ÛŒ Ø¨ÛŒØ´ØªØ± Ø´Ø¯
        velocity: 0, gravity: 0.25, jump: 4.6,
        draw: function() {
            // 1. Ú©Ù„Ø§Ù‡ (Ù‚Ø±Ù…Ø²)
            ctx.fillStyle = '#e74c3c';
            ctx.fillRect(this.x, this.y, this.w, 12);

            // 2. ØµÙˆØ±Øª (Ø±Ù†Ú¯ Ù¾ÙˆØ³Øª)
            ctx.fillStyle = '#ffe0bd'; 
            ctx.fillRect(this.x + 5, this.y + 12, 20, 12);

            // 3. Ú†Ø´Ù…â€ŒÙ‡Ø§ (Ù…Ø´Ú©ÛŒ)
            ctx.fillStyle = 'black';
            ctx.fillRect(this.x + 8, this.y + 16, 4, 4); 
            ctx.fillRect(this.x + 18, this.y + 16, 4, 4);

            // 4. Ø­Ø§Ø´ÛŒÙ‡ Ú©Ù„Ø§Ù‡ (Ø³ÙÛŒØ¯)
            ctx.fillStyle = 'white';
            ctx.fillRect(this.x, this.y + 10, this.w, 4);
            
            // 5. Ø±ÛŒØ´ Ø¨Ø²Ø±Ú¯ (Ø³ÙÛŒØ¯)
            ctx.fillRect(this.x, this.y + 22, this.w, 18);
        },
        update: function() {
            this.velocity += this.gravity;
            this.y += this.velocity;
            if(this.y + this.h >= canvas.height) gameOver();
        },
        flap: function() { this.velocity = -this.jump; }
    };

    const pipes = {
        items: [], w: 50, dx: 2, gap: 150,
        draw: function() {
            for(let i=0; i<this.items.length; i++) {
                let p = this.items[i];
                ctx.fillStyle = '#c0392b';
                ctx.fillRect(p.x, 0, this.w, p.top);
                ctx.fillRect(p.x, canvas.height - p.bottom, this.w, p.bottom);
                ctx.fillStyle = 'white';
                ctx.fillRect(p.x - 5, p.top - 10, this.w + 10, 10);
                ctx.fillRect(p.x - 5, canvas.height - p.bottom, this.w + 10, 10);
            }
        },
        update: function() {
            if(frames % 120 === 0) {
                let topHeight = Math.random() * (canvas.height - 300) + 50;
                this.items.push({ x: canvas.width, top: topHeight, bottom: canvas.height - (topHeight + this.gap) });
            }
            for(let i=0; i<this.items.length; i++) {
                let p = this.items[i];
                p.x -= this.dx;
                // ØªØ´Ø®ÛŒØµ Ø¨Ø±Ø®ÙˆØ±Ø¯
                if(santa.x + santa.w > p.x && santa.x < p.x + this.w && 
                   (santa.y < p.top || santa.y + santa.h > canvas.height - p.bottom)) {
                       gameOver();
                }
                if(p.x + this.w < 0) { this.items.shift(); score++; }
            }
        }
    };

    const snow = {
        flakes: [],
        init: function() {
            for(let i=0; i<50; i++) {
                this.flakes.push({ x: Math.random() * canvas.width, y: Math.random() * canvas.height, r: Math.random() * 3 + 1, d: Math.random() * 1 + 0.5 })
            }
        },
        draw: function() {
            ctx.fillStyle = "white"; ctx.beginPath();
            for(let i = 0; i < this.flakes.length; i++) {
                let f = this.flakes[i];
                ctx.moveTo(f.x, f.y); ctx.arc(f.x, f.y, f.r, 0, Math.PI * 2, true);
            }
            ctx.fill(); this.update();
        },
        update: function() {
            for (let i = 0; i < this.flakes.length; i++) {
                let f = this.flakes[i]; f.y += Math.pow(f.d, 2) + 1;
                if(f.y > canvas.height) { f.y = 0; f.x = Math.random() * canvas.width; }
            }
        }
    };

    function loop() {
        if(!gameRunning) return;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        let grd = ctx.createLinearGradient(0, 0, 0, canvas.height);
        grd.addColorStop(0, "#001f3f"); grd.addColorStop(1, "#3a6073");
        ctx.fillStyle = grd; ctx.fillRect(0,0, canvas.width, canvas.height);
        
        snow.draw(); 
        pipes.draw(); 
        pipes.update(); 
        santa.draw(); 
        santa.update();
        
        ctx.fillStyle = "gold"; ctx.font = "30px Arial"; ctx.fillText(score, 10, 40);
        frames++; requestAnimationFrame(loop);
    }

    // Ø§ØªØµØ§Ù„ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ Ø¨Ù‡ ØªÙˆØ§Ø¨Ø¹
    window.startGame = function() {
        document.getElementById('start-screen').style.display = 'none';
        santa.y = 150; santa.velocity = 0; pipes.items = []; score = 0; frames = 0;
        gameRunning = true;
        snow.init();
        loop();
    }

    function gameOver() {
        gameRunning = false;
        document.getElementById('final-score').innerText = score;
        document.getElementById('game-over-screen').style.display = 'block';
    }

    // --- ØªÙˆØ§Ø¨Ø¹ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ ---
    window.submitScore = async function() {
        const nameInput = document.getElementById('username');
        const name = nameInput.value;
        const btn = document.querySelector('#game-over-screen button');

        if(!name) { alert("Ù„Ø·ÙØ§ Ø§Ø³Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯!"); return; }

        btn.innerText = "Ø¯Ø± Ø­Ø§Ù„ Ø«Ø¨Øª...";
        btn.disabled = true;

        try {
            await addDoc(collection(db, "scores"), {
                name: name,
                score: score,
                date: new Date()
            });
            await showRewards();
        } catch (e) {
            console.error("Error adding document: ", e);
            alert("Ø®Ø·Ø§: Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ù…ØªØµÙ„ Ù†Ø´Ø¯. Ù„Ø·ÙØ§ Ú†Ú© Ú©Ù†ÛŒØ¯ Ø§ÛŒÙ†ØªØ±Ù†Øª ÙˆØµÙ„ Ø¨Ø§Ø´Ø¯ ÛŒØ§ ØªÙ†Ø¸ÛŒÙ…Ø§Øª ÙØ§ÛŒØ±Ø¨ÛŒØ³ ØµØ­ÛŒØ­ Ø¨Ø§Ø´Ø¯.");
            btn.innerText = "ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯";
            btn.disabled = false;
        }
    }

    async function showRewards() {
        document.getElementById('game-over-screen').style.display = 'none';
        document.getElementById('reward-screen').style.display = 'block';
        
        const music = document.getElementById('xmas-music');
        music.volume = 0.5;
        music.play().catch(e => console.log("Auto-play blocked"));

        try {
            const q = query(collection(db, "scores"), orderBy("score", "desc"), limit(10));
            const querySnapshot = await getDocs(q);

            const list = document.getElementById('leaderboard-list');
            list.innerHTML = "";
            
            let rank = 1;
            querySnapshot.forEach((doc) => {
                const entry = doc.data();
                const isMe = (entry.score === score && entry.name === document.getElementById('username').value);
                const li = document.createElement('li');
                
                li.innerHTML = `<span style="${isMe ? 'color: #f1c40f; font-weight:bold;' : ''}">${rank}. ${entry.name}</span> <span>${entry.score}</span>`;
                li.style.borderBottom = "1px solid rgba(255,255,255,0.2)";
                li.style.padding = "8px";
                li.style.display = "flex";
                li.style.justifyContent = "space-between";
                
                list.appendChild(li);
                rank++;
            });
        } catch (error) {
            console.log("Error getting docs", error);
            document.getElementById('leaderboard-list').innerHTML = "<li>Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª.</li>";
        }
    }

    window.addEventListener('click', () => { if(gameRunning) santa.flap(); });
    window.addEventListener('keydown', (e) => { 
        if(e.code === 'Space' && gameRunning) santa.flap(); 
    });
</script>

</body>
</html>
